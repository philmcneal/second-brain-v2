# üêõ BUG_PATTERNS.md ‚Äî Recurring Issues & Prevention Notes

This file tracks patterns spotted across nightly bug hunts. Each entry includes the root cause, prevention strategy, and whether a linter/test rule was added.

---

## Pattern 1: New API routes ship without tests

**First spotted:** 2026-02-19 (nightly bug hunt v2)  
**Affected files:** `app/api/config-analysis/route.ts`, `app/api/config-files/[filename]/route.ts` (both added in nightly/2026-02-18 with 0 test coverage)

**Root cause:** Feature pressure ‚Äî routes land in the same commit as UI components and there's no enforced test-coverage gate.

**Prevention:**
- When adding a new `route.ts`, create `__tests__/<name>.test.ts` in the same commit
- PR checklist: "Does this route have at least a happy-path and an error-path test?"
- Consider adding `--coverage --coverage.thresholds.lines=80` to CI (vitest supports this)

**Status:** Fixed 2026-02-19 ‚Äî 19 tests added covering both routes

---

## Pattern 2: Module-level mutable state in server routes

**First spotted:** 2026-02-19  
**Affected file:** `app/api/config-analysis/route.ts` ‚Äî `let suggestionIdCounter = 0`

**Root cause:** Using a module-level counter for ID generation. In a long-running Node.js process this works but the IDs drift indefinitely. In serverless/edge environments the counter resets on cold starts, creating ID gaps. Not a functional bug today but a gotcha if IDs are ever persisted externally.

**Prevention:**
- Prefer `crypto.randomUUID()` or `Date.now() + Math.random()` for IDs that don't need sequential ordering
- If sequential order matters, use the DB/store as the source of truth, not a process-level counter

**Status:** Low severity ‚Äî documented for future refactor

---

## Pattern 3: Bold-colon markdown format inconsistency in route parsers

**First spotted:** 2026-02-20 (nightly bug hunt v2)  
**Affected file:** `app/api/mission-control/commitments/route.ts`

**Root cause:** The route's field-parsing regexes (for Status, ETA, Last Update) require the colon OUTSIDE the bold markers ‚Äî e.g. `**Status**: done` ‚Äî but `buildCommitmentBlock` in `task-markdown.ts` writes the colon INSIDE the bold markers ‚Äî e.g. `**Status:** done`. This means the simpler route parser silently fails to read fields that `task-markdown.ts` produces, leaving statuses defaulted to "pending".

**Formats:**
- ‚úÖ Parsed by route: `**Status**: done` (colon outside bold)
- ‚ùå Not parsed by route: `**Status:** done` (colon inside bold, produced by `buildCommitmentBlock`)

**Prevention:**
- When writing field-parsing regexes, test against the EXACT output of any serialisation helper (`buildCommitmentBlock`, etc.)
- Add a unit test that round-trips: serialize with the writer function, then parse with the route ‚Äî assert the field values survive the round trip
- Consider aligning all helpers to one canonical format (colon outside bold is simpler to regex)

**Status:** Documented 2026-02-20. The route `commitments/route.ts` is a separate lightweight parser used only for dashboard display; `task-markdown.ts`'s `parseCommitmentsMarkdown` is used for bidirectional sync. Low severity for now but a latent inconsistency to resolve.

---

*Auto-generated by nightly bug hunt agent. Update this file when new patterns emerge.*
